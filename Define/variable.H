#include "stm32f10x_gpio.h"
#include "GPIO.H"
#include "char.H"


uchar bitSerial_ReceiveEnd;//串口接受完成标志位
uchar SerialReceiveLen;//串口额接收数据长度
uchar bitSerial_SendRequest;
uchar SerialReCase;//串口接受状态
uchar	bitEven;
uchar SerialReceiveTimeCount;
uint	SerialReCheckSum;
uchar	SerialReCheckSumCount;
uchar	rChar;

ulong BeepDelayTimeCount = 0;
uchar	DispBuffer[11];//显示数据
uint	MainCode;//站点号
uchar	customerId[20];//客户ID
uchar	customerkey[50];//客户秘钥
uchar posStyle;//设备类型
uchar	posVersion[50];//固件版本号
ulong ResetW5500Num  = 0;

unsigned char 		keybuff[4];

uchar		bitUpdateParameter=1;
union		sDatasUnion  SerialUnion;

uchar		NoNetRecord[32];//脱机记录
uchar   flag_off_full=0;//脱机记录满
uint   	offline_ReIndex;
uint   	offline_UpIndex =0;
uchar		flag_first_over=0;//第一条上传完成标志
uint 		Off_TimeCount = 0;

uchar 	flag_reupcode=2;//复采记录
uint  	UPD_TimeCount=0;
uchar		NeedSendRecordFlag = 0;
uchar		ReCardDatas[6];
uchar 	NetCardDatas[22];
uint   	recode_rdnum;
uchar   Udp_SerialNum =0;//序列号
ulong   NoNetLimetMoney = 3000;//脱机限额


uchar	Disp0_9String[10]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f};
const uchar	DefaultNetDatas[22]={192,168,10,44,0x28,0x23,192,168,10,1,
                                 255,255,255,0,0x12,0x34,192,168,10,188,0x23,0x28};//默认的网络参数

ulong		KeyValue;
uchar		InputBuffer[8];
unsigned char	  	Forbidden=0;
uchar	ReSerialComd;
uint	ReMainCode;		

//消费变量
uchar		usesectornum;//脱机扇区号															 
uchar 	CardPID[4];//卡片的唯一序列号
uchar 	CardPrintNum[4];//卡片的印刷编号
uchar		ConsumeMode;//消费模式
uchar 	CurrentConsumeMoney[4];//消费金额	
ulong		CurrentConsumMoney=0;//本次消费额	
uchar		ConsumMode;//消费方式
uchar  	Purse_num=1;
uchar   Consum_Status=1;//1--表示脱机
uchar		bitAddStatus=0;
ulong 	BeepTimes = 0;		
uchar   Num_MulValue=1;		
uchar		MoneyMulValue=1;//余额显示倍数;1--小数点2位；10-小数点1位，100-无小数点																 
uchar		InputCount=0;
ulong   Falsh_TimeCount=0;
union		uTimeUnion		SysTimeDatas;
union		uTimeUnion		SysTimeDatasBak;
uchar  	Pos_SysDate[6];//系统日期
uchar		DispModeChar[5]={0x1,0x04,0x08,0x10,0x02};
uchar		PosVerString[9]={0x76,0x6D,0x06,0xFb,0x71,0x06,0x07,0x3f,0x66};//17-0-4
uchar		LedWattingChar=0;
uchar 	TypeA_Sort = 0;
uchar		CardType[2];
uchar		CardSerialNum[4];
uchar		CardSerialNumBak[4];
uchar   CPU_RcLen_Data; 
uchar  	*CPU_RcLen= &CPU_RcLen_Data;
uchar   CPU_CommBuf[50];
uchar		CardIdentity;//身份
uchar   Card_Rebate = 100;//折扣
uchar		InputCase=0;
uchar		InputNum=0;
ulong		SingleMoney=0;
uchar		bitInPutPoint=0;
uchar		InputMaxNum=0;
uint		MulData=0;
uchar 	BatModeFlag;
uchar		bitHaveReadBalance=0;
uchar		bitHaveDispBalance=0;
uchar		Resend_Num=0;
uchar		ConsumModeEnable = 0x0d;//消费方式允许
ulong		SumConsumMoney=0;//总消费额
ulong		SumPrintMoney=0;//打印的总消费额

uchar   fristLook=0;
uchar   LookOk=0;
uchar   LookMony[8];
uchar		bitLookSysDatas=0;

uchar		bitDispFlash=0;
uchar   OutTimeFlag = 0;

uchar   Consum_Datas[8];
uchar   HaveQueryConDat = 0;
uchar   HeartBeatNum = 0;//心跳超时检测

uchar   NeedDispFlag = 0;//需要显示
uchar 	CardPrinterNum[6];//印刷编号
uchar   LimtConsumeData_CPU[4]={0x00,0x00,0x00,0x00};
uchar	  ConsumSndInfo[60];//CPU卡发送信息

u16  		TimerCount=0;
uchar   PsamRcvBufCount;
uchar   PsamRcvBuf[50];//psam
uchar 	LimtConsumeBuf[4]={0x00,0x00,0x50,0x00};//
ulong		LimtConsumeMoney=0;
uchar		bitHaveInputDatas=0;
ulong   LimtMoney;
uchar   HaveOffRecord =0;

uchar 	CanNoNetConsume =0;
uchar 	ComsumeDate[3];//消费日期
uchar 	HaveSendDataFlag = 0;//
uchar   ThreeRecord[24];

uchar		CardKeyCode[6];//读卡密码
uchar		CalCardKey[8];//卡密钥
uchar		CardSector;//公共区的扇区号 
ulong 	stationcode;//收费的站点号

 uchar	DispHardeErrorString[7*16]=
 {
/*0*/		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/*1*/		0x79,0x50,0x50,0x40,0x00,0x50,0x39,0x6d,0x3f,0x3f,0x00,0x00,0x00,0x00,0x00,0x00,//Err-RC500
/*2*/		0x79,0x50,0x50,0x40,0x00,0x6d,0x71,0x3f,0x5b,0x3f,0x00,0x00,0x00,0x00,0x00,0x00,//Err_SF020
/*3*/		0x79,0x50,0x50,0x40,0x00,0x5b,0x66,0x39,0x7d,0x66,0x00,0x00,0x00,0x00,0x00,0x00,//Err_24c64
/*4*/		0x79,0x50,0x50,0x40,0x00,0x5b,0x6d,0x3f,0x66,0x6d,0x00,0x00,0x00,0x00,0x00,0x00,//Err_25045
/*5*/		0x78,0x39,0x73,0x40,0x39,0x00,0x79,0x50,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//TCP_C Err
/*6*/		0x73,0x6d,0x77,0x40,0x00,0x00,0x79,0x50,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//PAS_C Err
 };

 uchar	DispErrorString[27*16]=
	{
/*0*/		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/*1*/		0x06,0x00,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//1 ERR CARD  非法卡
/*2*/		0x5b,0x00,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//2 ERR CARD		
/*3*/		0x4f,0x00,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//3 ERR CARD
/*4*/		0x66,0x00,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//4 ERR CARD
/*50*/	0x6d,0x00,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//5 ERR CARD
/*6*/		0x7d,0x00,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//6 ERR CARD
/*7*/		0x07,0x00,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//7 ERR CARD
/*8*/		0x7f,0x00,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//8 ERR CARD
/*9*/		0x6f,0x00,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//9 ERR CARD		
/*10*/	0x06,0x3f,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//10 ERR CARD
/*11*/	0x06,0x06,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//11 ERR CARD
/*12*/	0x06,0x5b,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//12 ERR CARD
/*13*/	0x06,0x4f,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//13 ERR CARD
/*14*/	0x06,0x66,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//14 ERR CARD
/*25*/	0x06,0x6d,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//15 ERR CARD
/*16*/	0x06,0x7d,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//16 ERR CARD
/*17*/	0x06,0x07,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//17 ERR CARD
/*18*/	0x06,0x3f,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//18 ERR CARD
/*19*/	0x06,0x06,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//19 ERR CARD

/*20*/	0x5b,0x3f,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//20 ERR CARD
/*21*/	0x5b,0x06,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//21 ERR CARD
/*22*/	0x5b,0x5b,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//22 ERR CARD
/*23*/	0x5b,0x4f,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//23 ERR CARD
/*24*/	0x5b,0x66,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//24 ERR CARD
/*25*/	0x5b,0x6d,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//25 ERR CARD
/*26*/	0x5b,0x7d,0x79,0x50,0x50,0x00,0x39,0x77,0x50,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,//26 ERR CARD
	};
	
																 



	